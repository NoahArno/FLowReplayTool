# FlowReplay 流量回放工具汇报方案

## 一、项目概述

FlowReplay 是一款基于 Java 21 开发的轻量级流量录制与回放工具，专为系统重构、迁移场景设计。该工具通过代理模式录制原系统（改造前）的真实流量，并在新系统（改造后）中回放验证，自动比对响应差异，帮助团队快速发现系统变更带来的问题。

**核心价值**：将传统手工测试转变为自动化流量回放测试，大幅降低系统重构和迁移的风险与成本，确保改造前后请求响应完全一致。

**适合场景**：系统重构，需要保障重构后的系统的响应与原系统一致。

**不适合场景**：

1. 由于 FlowReplay 是一款轻量级的流量回放工具，支持多种协议，且和语言无关的录制与回放，因此无法对系统的第三方调用进行 Mock（每次回放实际发送的都是真实的请求，如果该请求依赖第三方或者数据库，相同的请求可能导致不同的响应）
2. 该工具无法做测试案例的固化，且在录制和回放流量的时候，需要确保新老系统有完全相同的初始数据库，以及受第三方影响
---

## 二、核心功能

### 2.1 流量录制功能

**支持协议**：
- HTTP/WebService 协议
- TCP/Socket 协议

**录制方式**：
- 代理模式：在应用与目标服务之间部署代理服务器
- 语言无关：适用于 Java、Python、Go 等任何语言的系统
- 透明录制：无需修改业务代码

**录制内容**：
- 完整的请求数据（URL、方法、请求头、请求体）
- 完整的响应数据（状态码、响应头、响应体）
- 请求耗时、时间戳等元数据

### 2.2 流量回放功能

**回放模式**：
- **顺序回放**（默认）：严格按录制顺序执行，保证业务流程正确性
- **并发回放**：使用 Java 21 Virtual Threads 高性能并发执行

**回放能力**：
- 支持 HTTP 和 TCP 协议回放
- 自动重放所有录制的请求
- 实时统计回放耗时

### 2.3 响应比对功能

**多种比对策略**：
1. **完全匹配策略**：字节级精确比对，适用于 TCP 协议和静态资源
2. **HTTP 状态码策略**：仅比对状态码，快速验证接口可用性
3. **JSON 结构化策略**：智能比对 JSON 响应，支持忽略动态字段

**灵活配置**：
- 支持 YAML 配置文件自定义比对规则
- 可按 URL 模式配置不同的比对策略
- 支持忽略时间戳、UUID 等动态字段（需配置）

### 2.4 统计分析功能

**接口维度统计**：
- 按接口分组统计请求数、成功率
- 支持 URI 解析器（REST API）
- 支持 ESB 解析器（从报文解析 ServiceCode）

**性能对比分析**：
- 原始耗时 vs 回放耗时对比
- 接口级别的平均/最小/最大耗时统计
- 快速定位性能瓶颈接口

**可视化报告**：
- 自动生成 HTML 差异报告
- 并排展示录制响应与回放响应
- 差异高亮显示，快速定位问题
- 支持展开/折叠，便于浏览大量数据

### 2.4 示例展示

差异报告总览示例：
![差异报告总览示例](./差异报告总览示例.png)

差异报告详细示例：
![差异报告详细示例](./差异报告详细示例.png)

---

## 三、接入方式

### 3.1 部署步骤

**第一步：录制流量**

注意代理服务器的 JDK 版本要 21+

```bash
# HTTP/WebService 录制
java -jar flowreplay.jar record --port 8081 --target localhost:8080 --output ./recordings

# Socket 模式录制
java -jar flowreplay.jar record --protocol tcp --port 9999 --target localhost:9999 --output ./recordings-tcp --protocol-parser raw
  
```

**第二步：配置应用代理**

- 将应用的目标服务地址指向代理端口（8081）
- 代理会自动转发请求到真实服务并录制流量

**第三步：回放验证**

```bash
# 回放到新系统并生成报告
# 基础 HTTP 回放
java -jar flowreplay.jar replay --input ./recordings --target http://targetService:targetPort

# Socket 回放并比对
java -jar flowreplay.jar replay --input ./recordings-tcp --target targetService:targetPort --compare --report ./report.html

# 使用自定义比对规则
java -jar flowreplay.jar replay --input ./recordings --target http://targetService:targetPort --compare --report ./report.html --config ./rules.yaml
```

---

## 四、预期效果

**自动化比对**：
- 自动比对所有接口响应，无遗漏
- 按接口统计成功率，快速定位问题接口
- 生成详细差异报告，精确定位差异内容

**性能问题发现**：
- 对比原始耗时与回放耗时
- 发现性能退化的接口
- 识别性能不稳定的接口

---

## 五、工作量节省估算

**假设场景**：将系统从旧框架迁移到新框架，或者系统进行重构

**传统测试方式**：
- 全量回归测试：10 个工作日
- 问题修复与验证：5 个工作日
- **总计**：15 个工作日

**流量回放方式**：
- 录制实际流量：1 个工作日
- 回放验证：0.5 个工作日
- 分析报告并修复：3 个工作日
- 再次回放验证：0.5 个工作日
- **总计**：5 个工作日

**节省工作量**：10 个工作日，节省 66% 的工作量

---