# FlowReplay 接口统计功能使用说明

## 功能概述

FlowReplay 现在支持按接口维度统计回放结果，可以清晰地看到每个接口的匹配情况。

### 核心特性

1. **按接口统计**：将回放结果按接口分组统计，显示每个接口的总请求数、匹配成功数、匹配失败数和成功率
2. **可扩展的解析器**：支持自定义接口名解析器，适配不同的系统架构
3. **内置解析器**：
   - **URI解析器**（默认）：使用请求的URI作为接口名
   - **ESB解析器**：从请求报文中解析ServiceCode作为接口名

## 使用方法

### 1. 基本用法（使用默认URI解析器）

```bash
java -jar flowreplay-cli-1.0.0-SNAPSHOT-jar-with-dependencies.jar replay \
  --input ./recordings \
  --target http://localhost:9090 \
  --compare \
  --report ./report.html
```

**说明**：
- 不指定 `--service-parser` 参数时，默认使用URI作为接口名
- 例如：`/api/user/login` 和 `/api/user/register` 会被识别为两个不同的接口

### 2. 使用ESB解析器

```bash
java -jar flowreplay-cli-1.0.0-SNAPSHOT-jar-with-dependencies.jar replay \
  --input ./recordings \
  --target http://localhost:9090 \
  --compare \
  --report ./report.html \
  --service-parser esb
```

**说明**：
- 适用于ESB系统或类似架构（只暴露一个统一入口，通过报文内容区分实际接口）
- 会从请求报文中解析ServiceCode字段作为接口名

### 3. ESB解析器支持的报文格式

#### XML格式
```xml
<Request>
    <ServiceCode>QueryUserInfo</ServiceCode>
    <Data>
        <UserId>12345</UserId>
    </Data>
</Request>
```

#### JSON格式
```json
{
    "ServiceCode": "QueryUserInfo",
    "Data": {
        "UserId": "12345"
    }
}
```

**解析规则**：
- XML：提取 `<ServiceCode>` 标签中的内容
- JSON：提取 `ServiceCode` 字段的值
- 如果无法解析到ServiceCode，则回退使用URI作为接口名

## HTML报告展示

生成的HTML报告包含两个统计维度：

### 1. 总体统计（原有功能）
显示所有请求的汇总信息：
- 总请求数
- 匹配成功数
- 匹配失败数
- 成功率

### 2. 接口统计（新增功能）
按接口分组展示统计信息，表格包含以下列：

| 接口名称 | 总请求数 | 匹配成功 | 匹配失败 | 成功率 |
|---------|---------|---------|---------|--------|
| /api/user/login | 10 | 8 | 2 | 80.00% |
| /api/user/register | 5 | 5 | 0 | 100.00% |
| /api/order/create | 15 | 12 | 3 | 80.00% |

**说明**：
- 绿色数字表示匹配成功
- 红色数字表示匹配失败
- 可以快速定位哪些接口存在问题

## 完整使用示例

### 场景1：普通HTTP接口回放

```bash
# 1. 录制流量
java -jar flowreplay-cli-1.0.0-SNAPSHOT-jar-with-dependencies.jar record \
  --port 8080 \
  --target localhost:8080 \
  --output ./recordings

# 2. 回放并生成报告（使用默认URI解析器）
java -jar flowreplay-cli-1.0.0-SNAPSHOT-jar-with-dependencies.jar replay \
  --input ./recordings \
  --target http://localhost:9090 \
  --compare \
  --report ./report.html
```

**结果**：报告中会按URI统计，例如：
- `/api/user/login` - 10次请求，8次成功
- `/api/user/register` - 5次请求，5次成功
- `/api/order/list` - 20次请求，18次成功

### 场景2：ESB系统回放

```bash
# 1. 录制ESB流量
java -jar flowreplay-cli-1.0.0-SNAPSHOT-jar-with-dependencies.jar record \
  --port 8080 \
  --target esb-server:8080 \
  --output ./recordings

# 2. 回放并生成报告（使用ESB解析器）
java -jar flowreplay-cli-1.0.0-SNAPSHOT-jar-with-dependencies.jar replay \
  --input ./recordings \
  --target http://new-esb-server:9090 \
  --compare \
  --report ./report.html \
  --service-parser esb
```

**结果**：报告中会按ServiceCode统计，例如：
- `QueryUserInfo` - 10次请求，8次成功
- `CreateOrder` - 5次请求，5次成功
- `UpdateUserProfile` - 20次请求，18次成功

## 参数说明

### --service-parser 参数

| 值 | 说明 | 适用场景 |
|----|------|---------|
| `uri` | 使用URI作为接口名（默认） | 普通REST API、微服务 |
| `esb` | 从报文解析ServiceCode | ESB系统、统一网关 |

**注意**：
- 如果不指定此参数，默认使用 `uri` 解析器
- 解析器名称不区分大小写

## 常见问题

### Q1: 如何查看帮助信息？

```bash
java -jar flowreplay-cli-1.0.0-SNAPSHOT-jar-with-dependencies.jar
```

不带任何参数运行即可查看完整的使用说明。

### Q2: ESB解析器无法识别ServiceCode怎么办？

**可能原因**：
1. 报文格式不符合要求（不是XML或JSON）
2. 字段名不是 `ServiceCode`（区分大小写）
3. 报文编码问题

**解决方案**：
- 检查录制的请求报文格式
- 如果字段名不同，可以自定义解析器（参考扩展开发部分）
- 如果无法解析，系统会自动回退使用URI

### Q3: 可以同时使用多个解析器吗？

不可以。每次回放只能指定一个解析器。如果需要不同的统计维度，可以多次回放生成不同的报告。

### Q4: 如何自定义解析器？

如果内置的解析器不满足需求，可以自定义解析器：

1. 实现 `ServiceNameParser` 接口
2. 在 `ServiceNameParserFactory` 中注册
3. 重新编译打包

**示例代码**：
```java
public class CustomParser implements ServiceNameParser {
    @Override
    public String parseServiceName(TrafficRecord record) {
        // 自定义解析逻辑
        return "your-service-name";
    }

    @Override
    public String getParserName() {
        return "custom";
    }
}
```

## 技术实现说明

### 架构设计

```
┌─────────────────────────────────────────┐
│         HtmlReportGenerator             │
│  (生成HTML报告)                          │
└──────────────┬──────────────────────────┘
               │
               │ 使用
               ↓
┌─────────────────────────────────────────┐
│    ServiceNameParserFactory             │
│  (解析器工厂)                            │
└──────────────┬──────────────────────────┘
               │
               │ 创建
               ↓
┌─────────────────────────────────────────┐
│      ServiceNameParser (接口)           │
└──────────────┬──────────────────────────┘
               │
       ┌───────┴────────┐
       ↓                ↓
┌──────────────┐  ┌──────────────┐
│ UriParser    │  │ EsbParser    │
│ (URI解析器)  │  │ (ESB解析器)  │
└──────────────┘  └──────────────┘
```

### 核心类说明

1. **ServiceNameParser**：接口名解析器接口
2. **UriServiceNameParser**：默认URI解析器
3. **EsbServiceNameParser**：ESB系统解析器
4. **ServiceNameParserFactory**：解析器工厂
5. **ServiceStatistics**：接口统计数据模型

## 快速开始

### 第一步：编译项目

```bash
cd C:\Users\Admin\Desktop\vibecoding_workspace\flowReplay
mvn clean package -DskipTests
```

### 第二步：找到可执行JAR

编译成功后，可执行JAR位于：
```
flowreplay-cli\target\flowreplay-cli-1.0.0-SNAPSHOT-jar-with-dependencies.jar
```

### 第三步：运行回放

```bash
# 使用默认URI解析器
java -jar flowreplay-cli\target\flowreplay-cli-1.0.0-SNAPSHOT-jar-with-dependencies.jar replay \
  --input ./recordings \
  --target http://localhost:9090 \
  --compare \
  --report ./report.html

# 或使用ESB解析器
java -jar flowreplay-cli\target\flowreplay-cli-1.0.0-SNAPSHOT-jar-with-dependencies.jar replay \
  --input ./recordings \
  --target http://localhost:9090 \
  --compare \
  --report ./report.html \
  --service-parser esb
```

### 第四步：查看报告

在浏览器中打开生成的 `report.html` 文件，即可看到：
- 总体统计信息
- **接口统计表格**（新增功能）
- 详细差异列表

