# FlowReplay 时间统计功能说明

## 功能概述

FlowReplay 现在支持详细的时间统计功能，可以对比原始请求和回放请求的耗时情况。

## 新增功能

### 1. 单个请求的时间展示

在每个请求的详细信息中，现在会显示：
- **原始耗时**：录制时该请求的实际耗时
- **回放耗时**：回放时该请求的实际耗时

**展示位置**：在请求详情的基本信息部分

**示例**：
```
请求 #1 - req-001
协议: HTTP
URI: /api/user/login
方法: POST
接口名: /api/user/login
状态: ✓ 匹配
原始耗时: 125 ms
回放耗时: 138 ms
```

### 2. 接口级别的时间统计

在接口统计表格中，新增了详细的时间统计列：

#### 原始耗时统计（3列）
- **平均耗时**：该接口所有原始请求的平均耗时
- **最小耗时**：该接口原始请求的最小耗时
- **最大耗时**：该接口原始请求的最大耗时

#### 回放耗时统计（3列）
- **平均耗时**：该接口所有回放请求的平均耗时
- **最小耗时**：该接口回放请求的最小耗时
- **最大耗时**：该接口回放请求的最大耗时

### 3. 接口统计表格示例

| 接口名称 | 总请求数 | 匹配成功 | 匹配失败 | 成功率 | 原始耗时(ms) ||| 回放耗时(ms) |||
|---------|---------|---------|---------|--------|------|------|------|------|------|------|
|         |         |         |         |        | 平均 | 最小 | 最大 | 平均 | 最小 | 最大 |
| /api/user/login | 10 | 8 | 2 | 80.00% | 125.50 | 98 | 156 | 138.20 | 105 | 178 |
| /api/user/register | 5 | 5 | 0 | 100.00% | 89.40 | 75 | 112 | 92.60 | 78 | 118 |
| /api/order/create | 15 | 12 | 3 | 80.00% | 234.67 | 189 | 298 | 245.33 | 195 | 312 |

## 数据来源说明

### 原始耗时数据

原始耗时数据来自录制时保存在 `TrafficRecord.metadata` 中的 `duration` 字段。

**注意**：如果录制时没有保存耗时信息，原始耗时将显示为 0。

### 回放耗时数据

回放耗时数据由 `TrafficReplayer` 在回放过程中实时测量，保存在 `ReplayResult.duration` 字段中。

## 使用场景

### 1. 性能对比分析

通过对比原始耗时和回放耗时，可以评估：
- 新系统的性能是否有提升或下降
- 哪些接口的性能变化最明显
- 性能瓶颈在哪些接口

**示例分析**：
- 如果回放耗时普遍高于原始耗时，说明新系统性能可能有所下降
- 如果某个接口的回放耗时明显增加，需要重点关注该接口的实现

### 2. 接口性能排查

通过查看最大耗时和最小耗时，可以发现：
- 哪些接口存在性能不稳定的情况
- 是否存在异常慢的请求
- 接口性能的波动范围

### 3. 系统重构验证

在系统重构后，通过时间统计可以验证：
- 重构是否达到了性能优化的目标
- 是否引入了新的性能问题
- 各接口的性能变化趋势

## 技术实现说明

### 修改的文件

1. **ComparisonReport.java**
   - 新增 `replayDuration` 字段，记录回放耗时

2. **ServiceStatistics.java**
   - 新增原始耗时统计字段（总耗时、最小、最大）
   - 新增回放耗时统计字段（总耗时、最小、最大）
   - 新增 `addDuration()` 方法用于更新耗时统计
   - 新增获取各项耗时统计的方法

3. **HtmlReportGenerator.java**
   - 修改接口统计表格，添加时间统计列
   - 修改单个请求详情展示，添加原始耗时和回放耗时
   - 新增 `getOriginalDuration()` 辅助方法

4. **FlowReplayCLI.java**
   - 修改创建 `ComparisonReport` 时传递 `replayDuration` 参数

## 注意事项

### 1. 原始耗时数据的获取

原始耗时需要在录制时保存到 `metadata` 中。如果使用代理录制，需要确保代理服务器计算并保存了耗时信息。

**代理服务器需要做的修改**：
```java
// 在录制时计算耗时
long startTime = System.currentTimeMillis();
// ... 发送请求并获取响应
long duration = System.currentTimeMillis() - startTime;

// 保存到 metadata
Map<String, Object> metadata = new HashMap<>();
metadata.put("duration", duration);
```

### 2. 时间单位

所有时间统计均使用**毫秒（ms）**作为单位。

### 3. 平均耗时的计算

平均耗时 = 总耗时 / 请求总数

保留两位小数显示。

## 完整功能总结

现在 FlowReplay 的 HTML 报告包含以下内容：

1. **总体统计**：总请求数、匹配成功数、匹配失败数、成功率
2. **接口统计**：按接口分组的详细统计，包括：
   - 请求数统计
   - 匹配情况统计
   - **原始耗时统计**（平均、最小、最大）
   - **回放耗时统计**（平均、最小、最大）
3. **详细差异列表**：每个请求的详细信息，包括：
   - 基本信息（协议、URI、方法、接口名、状态）
   - **原始耗时和回放耗时**
   - 原始请求详情
   - 响应对比
   - IDEA风格差异详情

